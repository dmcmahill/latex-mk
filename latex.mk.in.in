# $Id: latex.mk.in.in,v 1.7 2002/08/29 01:01:00 dan Exp $
#
# Makefile fragment for handling LaTeX projects
#
# Copyright (c) 2001, 2002 Dan McMahill
# All rights reserved.
#
# This code is derived from software written by Dan McMahill
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 3. All advertising materials mentioning features or use of this software
#    must display the following acknowledgement:
#        This product includes software developed by Dan McMahill
#  4. The name of the author may not be used to endorse or promote products
#     derived from this software without specific prior written permission.
# 
#  THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
#  IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
#  OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
#  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
#  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
#  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
#  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED
#  AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
#  OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
#  OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
#  SUCH DAMAGE.
#


#######################################
#
# README:
#
# To use this makefile fragment, set the variable:
#	NAME	= Top level project name.  Your top level LaTeX 
#		  file should be called $(NAME).tex
#
#	TEXSRCS	= Additional LaTeX input files (.tex)
#
# and add the line:
#	.include "latex.mk"
# in your top level Makefile
#
# The following variables may be overridden in your top level Makefile
#
#  BIBTEX	= the BibTeX executable
#  BIBTEX_ENV	= environment variables set when running the BibTeX executable
#  BIBEX_FLAGS	= flags passed to the BibTeX executable
#  DVIPS	= the dvips executable
#  DVIPS_FLAGS	= flags passed to the dvips executable
#  GV		= a postscript previewer executable
#  GV_FLAGS	= flags passed to the postscript previewer executable
#  LATEX	= the LaTeX executable
#  LATEX_ENV	= environment variables set when running the LaTeX executable
#  LATEX_FLAGS	= flags passed to the LaTeX executable
#  LPR		= executable to print postscript files
#  LPR_FLAGS	= flags passed to the executable to print postscript files
#  PS2PDF	= ps2pdf executable
#  PS2PDF_FLAGS	= flags passed to the ps2pdf executable
#  XDVI		= a .dvi previewer executable
#  XDVI_FLAGS	= flags passed to the .dvi previewer executable
#
#######################################


BMK:MAKECONF?=	@MAKECONF@
BMK:USER_MAKECONF?=	@USERMAKECONF@
GMK:MAKECONF?=	@GMAKECONF@
GMK:USER_MAKECONF?=	@USERGMAKECONF@

BMK:.if exists(${MAKECONF})
BMK:.include "${MAKECONF}"
BMK:.endif
BMK:
BMK:.if exists(${USER_MAKECONF})
BMK:.include "${USER_MAKECONF}"
BMK:.endif

GMK:_CONFS= $(wildcard ${MAKECONF})
GMK:_CONFS+=        $(wildcard ${USER_MAKECONF})
GMK:include ${_CONFS}


BIBTEX?=	@BIBTEX@
DVIPS?=		@DVIPS@
DVIPS_FLAGS+=	-Ppdf -j0
ECHO?=		@ECHO@
ENV_PROG?=	@ENV_PROG@
FALSE?=		@FALSE@
GV?=		@GV@
LATEX?=		@LATEX@
LATEX_ENV?=	
LPR?=		@LPR@
LPR_FLAGS?=	
PS2PDF?=	@PS2PDF@
PS2PDF_FLAGS?=	
XDVI?=		@XDVI@
XDVI_FLAGS?=	

RM?=		@RM@

# Include other .mk files often times used with LaTeX
BMK:.if defined(TGIFSRCS) || defined(TGIFDIRS)
BMK:.include "tgif.mk"
BMK:.endif

GMK:ifdef TGIFSRCS
_USE_TGIF_MK+=	YES
GMK:endif
GMK:ifdef TGIFDIRS
_USE_TGIF_MK+=	YES
GMK:endif
GMK:ifdef _USE_TGIF_MK
GMK:include @pkgdatadir@/tgif.mk
GMK:endif

BMK:.if defined(XFIGSRCS) || defined(XFIGDIRS)
BMK:.include "xfig.mk"
BMK:.endif

GMK:ifdef XFIGSRCS
_USE_XFIG_MK+=	YES
GMK:endif
GMK:ifdef XFIGDIRS
_USE_XFIG_MK+=	YES
GMK:endif
GMK:ifdef _USE_XFIG_MK
GMK:include @pkgdatadir@/xfig.mk
GMK:endif

.MAIN: view

all:: view

# target 'view' will only have latex run once.  Thus the preview
# will not always have all the figure and equation references
# up to date
.PHONY: view
view: $(NAME).dvi
	$(XDVI) $(XDVI_FLAGS) $(NAME).dvi

.PHONY: viewps
viewps: $(NAME).ps
	$(GV) $(GV_FLAGS) $(NAME).ps

.PHONY:  print
print: $(NAME).ps
	$(LPR) $(LPR_FLAGS) $(NAME).ps


#######################################
#
# DVI Output (latex)
#
#######################################
.PHONY: dvi
dvi:	$(NAME).dvi

TEXSRCS+=	$(NAME).tex

$(NAME).dvi: $(TEXSRCS) $(BIBTEXSRCS) $(OTHER)
	$(ENV_PROG) $(LATEX_ENV) $(LATEX) $(NAME) || (${RM} $(NAME).dvi && ${FALSE})
BMK:.ifdef BIBTEXSRCS
GMK:ifdef BIBTEXSRCS
	@$(ECHO) BibTeXing and rerunning LaTeX to get references right
	$(ENV_PROG) $(BIBTEX_ENV) $(BIBTEX) $(NAME) || (${RM} $(NAME).dvi && ${FALSE})
	$(ENV_PROG) $(LATEX_ENV) $(LATEX) $(NAME) || (${RM} $(NAME).dvi && ${FALSE})
BMK:.endif
GMK:endif
	$(ENV_PROG) $(LATEX_ENV) $(LATEX) $(NAME) || (${RM} $(NAME).dvi && ${FALSE})


#######################################
#
# Postscript Output (dvips)
#
#######################################
.PHONY:  ps
ps: $(NAME).ps

$(NAME).ps: $(NAME).dvi
	@${ECHO} "running latex again to make sure all figure/equation references are up to date"
	$(ENV_PROG) $(LATEX_ENV) $(LATEX) $(NAME) || (${RM} $(NAME).dvi && ${FALSE})
	$(DVIPS) $(DVIPS_FLAGS) -o $(NAME).ps $(NAME).dvi

#######################################
#
# PDF Output (ps2pdf)
#
#######################################
.PHONY:  pdf
pdf: $(NAME).pdf

$(NAME).pdf: $(NAME).ps
	$(PS2PDF) $(PS2PDF_FLAGS) $(NAME).ps 


#######################################
#
# Clean up (clean)
#
#######################################
BMK:.ifdef TEXSRCS
GMK:ifdef TEXSRCS
CLEAN_FILES+=	${TEXSRCS:.tex=.aux}
BMK:.endif
GMK:endif

BMK:.ifdef BIBTEXSRCS
GMK:ifdef BIBTEXSRCS
CLEAN_FILES+=	${BIBTEXSRCS:.bib=.aux}
BMK:.endif
GMK:endif

.PHONY: clean
clean::
	$(RM) -f *~ $(NAME).ps $(NAME).pdf $(NAME).aux $(NAME).log \
		$(NAME).dvi $(NAME).log $(NAME).bbl $(NAME).blg texput.log \
		$(NAME).lof $(NAME).lot $(NAME).toc $(NAME).out $(CLEAN_FILES)

.PHONY: distclean
distclean: clean

#######################################
#
# Some helpful debugging targets
#
#######################################
.PHONY: show-var
show-var:
	@${ECHO} ${${VARNAME}}
