# $Id: latex.mk.in.in,v 1.11 2002/09/18 02:45:06 dan Exp $
#
# Makefile fragment for handling LaTeX projects
#
# Copyright (c) 2001, 2002 Dan McMahill
# All rights reserved.
#
# This code is derived from software written by Dan McMahill
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 3. All advertising materials mentioning features or use of this software
#    must display the following acknowledgement:
#        This product includes software developed by Dan McMahill
#  4. The name of the author may not be used to endorse or promote products
#     derived from this software without specific prior written permission.
# 
#  THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
#  IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
#  OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
#  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
#  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
#  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
#  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED
#  AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
#  OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
#  OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
#  SUCH DAMAGE.
#


#######################################
#
# README:
#
# To use this makefile fragment, set the variable:
#	NAME	= Top level project name.  Your top level LaTeX 
#		  file should be called $(NAME).tex
#
#	TEXSRCS	= Additional LaTeX input files (.tex)
#
# and add the line:
#	.include "latex.mk"
# in your top level Makefile
#
# The following variables may be overridden in your top level Makefile
#
#  BIBTEX	= the BibTeX executable
#  BIBTEX_ENV	= environment variables set when running the BibTeX executable
#  BIBEX_FLAGS	= flags passed to the BibTeX executable
#  DVIPS	= the dvips executable
#  DVIPS_FLAGS	= flags passed to the dvips executable
#  GV		= a postscript previewer executable
#  GV_FLAGS	= flags passed to the postscript previewer executable
#  LATEX	= the LaTeX executable
#  LATEX_ENV	= environment variables set when running the LaTeX executable
#  LATEX_FLAGS	= flags passed to the LaTeX executable
#  LPR		= executable to print postscript files
#  LPR_FLAGS	= flags passed to the executable to print postscript files
#  PS2PDF	= ps2pdf executable
#  PS2PDF_FLAGS	= flags passed to the ps2pdf executable
#  XDVI		= a .dvi previewer executable
#  XDVI_FLAGS	= flags passed to the .dvi previewer executable
#
#######################################


BMK:MAKECONF?=	@MAKECONF@
BMK:USER_MAKECONF?=	@USERMAKECONF@
GMK:MAKECONF?=	@GMAKECONF@
GMK:USER_MAKECONF?=	@USERGMAKECONF@

BMK:.if exists(${MAKECONF})
BMK:.include "${MAKECONF}"
BMK:.endif
BMK:
BMK:.if exists(${USER_MAKECONF})
BMK:.include "${USER_MAKECONF}"
BMK:.endif

GMK:_CONFS= $(wildcard ${MAKECONF})
GMK:_CONFS+=        $(wildcard ${USER_MAKECONF})
GMK:include ${_CONFS}

# The location of the latex-mk .mk and .gmk files
# we do this instead of hard coding so the package
# can be tested before installation by setting this
# variable in a test config file
LATEX_MK_DIR?=	@pkgdatadir@

BIBTEX?=	@BIBTEX@
DVIPS?=		@DVIPS@
DVIPS_FLAGS+=	-Ppdf -j0
ECHO?=		@ECHO@
ENV_PROG?=	@ENV_PROG@
FALSE?=		@FALSE@
GV?=		@GV@
LATEX-MK?=	@bindir@/latex-mk
LATEX?=		@LATEX@
LATEX_ENV?=	
LPR?=		@LPR@
LPR_FLAGS?=	
PS2PDF?=	@PS2PDF@
PS2PDF_FLAGS?=	
XDVI?=		@XDVI@
XDVI_FLAGS?=	

RM?=		@RM@

# Include other .mk files often times used with LaTeX
BMK:.if defined(TGIFSRCS) || defined(TGIFDIRS)
BMK:.include "tgif.mk"
BMK:.endif

GMK:ifdef TGIFSRCS
_USE_TGIF_MK+=	YES
GMK:endif
GMK:ifdef TGIFDIRS
_USE_TGIF_MK+=	YES
GMK:endif
GMK:ifdef _USE_TGIF_MK
GMK:include ${LATEX_MK_DIR}/tgif.gmk
GMK:endif

BMK:.if defined(XFIGSRCS) || defined(XFIGDIRS)
BMK:.include "xfig.mk"
BMK:.endif

GMK:ifdef XFIGSRCS
_USE_XFIG_MK+=	YES
GMK:endif
GMK:ifdef XFIGDIRS
_USE_XFIG_MK+=	YES
GMK:endif
GMK:ifdef _USE_XFIG_MK
GMK:include ${LATEX_MK_DIR}/xfig.gmk
GMK:endif

.MAIN: view

all:: view

# target 'view' will only have latex run once.  Thus the preview
# will not always have all the figure and equation references
# up to date
BMK:.for __tmp__ in ${NAME}
.PHONY: view_${__tmp__}
view_${__tmp__}: ${__tmp__}.dvi
	$(XDVI) $(XDVI_FLAGS) ${__tmp__}.dvi
DEFAULTVIEW?=	view_${__tmp__}
ALLVIEW+=	view_${__tmp__}
BMK:.endfor
.PHONY: view
view: ${DEFAULTVIEW}
.PHONY: view-all
view-all: ${ALLVIEW}


BMK:.for __tmp__ in ${NAME}
.PHONY: viewps_${__tmp__}
viewps_${__tmp__}: ${__tmp__}.ps
	$(GV) $(GV_FLAGS)  ${__tmp__}.ps
DEFAULTVIEWPS?=	viewps_${__tmp__}
ALLVIEWPS+=	viewps_${__tmp__}
BMK:.endfor
.PHONY: viewps
viewps: ${DEFAULTVIEWPS}
.PHONY: viewps-all
viewps-all: ${ALLVIEWPS}

BMK:.for __tmp__ in ${NAME}
.PHONY: print_${__tmp__}
print_${__tmp__}: ${__tmp__}.ps
	$(LPR) $(LPR_FLAGS) ${__tmp__}.ps
DEFAULTPRINT?=	print_${__tmp__}
ALLPRINT+=	print_${__tmp__}
BMK:.endfor
.PHONY: print
print: ${DEFAULTPRINT}
.PHONY: print-all
print-all: ${ALLPRINT}

#######################################
#
# DVI Output (latex)
#
#######################################
.PHONY: dvi

ALLTEXSRCS=	${TEXSRCS}
ALLBIBTEXSRCS=	${BIBTEXSRCS}
# add the dependencies for each documents .dvi file
BMK:.for __tmp__ in ${NAME}
BMK:${__tmp__}.dvi:	${__tmp__}.tex ${TEXSRCS} ${${__tmp__}_TEXSRCS} ${BIBTEXSRCS} ${${__tmp__}_BIBTEXSRCS} ${OTHER} ${${__tmp__}_OTHER}
BMK:
BMK:ALLTEXSRCS+=	${__tmp__}.tex ${${__tmp__}_TEXSRCS}
BMK:ALLBIBTEXSRCS+=	${${__tmp__}_BIBTEXSRCS}
BMK:dvi:	${__tmp__}.dvi
BMK:ps:	${__tmp__}.ps
BMK:pdf:	${__tmp__}.pdf
BMK:.endfor

.SUFFIXES : .tex .dvi .ps .pdf

.tex.dvi : 
	$(ENV_PROG) $(LATEX_ENV) $(LATEX-MK) $<

#######################################
#
# Postscript Output (dvips)
#
#######################################
.PHONY:  ps

.dvi.ps :
	$(DVIPS) $(DVIPS_FLAGS) -o $@ $<

#######################################
#
# PDF Output (ps2pdf)
#
#######################################
.PHONY:  pdf

.ps.pdf :
	$(PS2PDF) $(PS2PDF_FLAGS) $<


#######################################
#
# Clean up (clean)
#
#######################################
CLEAN_FILES+=	${ALLTEXSRCS:.tex=.aux}
CLEAN_FILES+=	${BIBTEXSRCS:.bib=.aux}
BMK:.for __tmp__ in ${NAME}
CLEAN_FILES+=	${__tmp__}.ps
CLEAN_FILES+=	${__tmp__}.pdf
CLEAN_FILES+=	${__tmp__}.aux
CLEAN_FILES+=	${__tmp__}.log
CLEAN_FILES+=	${__tmp__}.dvi
CLEAN_FILES+=	${__tmp__}.log
CLEAN_FILES+=	${__tmp__}.bbl
CLEAN_FILES+=	${__tmp__}.blg
CLEAN_FILES+=	${__tmp__}.lof
CLEAN_FILES+=	${__tmp__}.lot
CLEAN_FILES+=	${__tmp__}.toc
CLEAN_FILES+=	${__tmp__}.out
BMK:.endfor

.PHONY: clean
clean::
	$(RM) -f *~ texput.log $(CLEAN_FILES)

.PHONY: distclean
distclean: clean

#######################################
#
# Some helpful debugging targets
#
#######################################
.PHONY: show-var
show-var:
	@${ECHO} ${${VARNAME}}
