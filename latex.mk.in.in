# $Id: latex.mk.in.in,v 1.16 2002/09/30 03:05:05 dan Exp $
#
# Makefile fragment for handling LaTeX projects
#
# Copyright (c) 2001, 2002 Dan McMahill
# All rights reserved.
#
# This code is derived from software written by Dan McMahill
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 3. All advertising materials mentioning features or use of this software
#    must display the following acknowledgement:
#        This product includes software developed by Dan McMahill
#  4. The name of the author may not be used to endorse or promote products
#     derived from this software without specific prior written permission.
# 
#  THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
#  IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
#  OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
#  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
#  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
#  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
#  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED
#  AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
#  OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
#  OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
#  SUCH DAMAGE.
#


#######################################
#
# README:
#
# To use this makefile fragment, set the variable:
#	NAME	= Top level project name.  Your top level LaTeX 
#		  file should be called $(NAME).tex
#
#	TEXSRCS	= Additional LaTeX input files (.tex)
#
# and add the line:
#	.include "latex.mk"
# in your top level Makefile
#
# The following variables may be overridden in your top level Makefile
#
#  BIBTEX	= the BibTeX executable
#  BIBTEX_ENV	= environment variables set when running the BibTeX executable
#  BIBEX_FLAGS	= flags passed to the BibTeX executable
#  DVIPS	= the dvips executable
#  DVIPS_FLAGS	= flags passed to the dvips executable
#  GV		= a postscript previewer executable
#  GV_FLAGS	= flags passed to the postscript previewer executable
#  LATEX	= the LaTeX executable
#  LATEX_ENV	= environment variables set when running the LaTeX executable
#  LATEX_FLAGS	= flags passed to the LaTeX executable
#  LPR		= executable to print postscript files
#  LPR_FLAGS	= flags passed to the executable to print postscript files
#  PS2PDF	= ps2pdf executable
#  PS2PDF_FLAGS	= flags passed to the ps2pdf executable
#  XDVI		= a .dvi previewer executable
#  XDVI_FLAGS	= flags passed to the .dvi previewer executable
#
#######################################


BMK:MAKECONF?=	@MAKECONF@
BMK:USER_MAKECONF?=	@USERMAKECONF@
GMK:MAKECONF?=	@GMAKECONF@
GMK:USER_MAKECONF?=	@USERGMAKECONF@

BMK:.if exists(${MAKECONF})
BMK:.include "${MAKECONF}"
BMK:.endif
BMK:
BMK:.if exists(${USER_MAKECONF})
BMK:.include "${USER_MAKECONF}"
BMK:.endif

GMK:_CONFS= $(wildcard ${MAKECONF})
GMK:_CONFS+=        $(wildcard ${USER_MAKECONF})
GMK:include ${_CONFS}

# The location of the latex-mk .mk and .gmk files
# we do this instead of hard coding so the package
# can be tested before installation by setting this
# variable in a test config file
LATEX_MK_DIR?=	@pkgdatadir@

BIBTEX?=	@BIBTEX@
DVIPS?=		@DVIPS@
DVIPS_FLAGS+=	-Ppdf -j0
ECHO?=		@ECHO@
ENV_PROG?=	@ENV_PROG@
FALSE?=		@FALSE@
GV?=		@GV@
GV_FLAGS?=	
LATEX-MK?=	@bindir@/latex-mk
LATEX?=		@LATEX@
LATEX_ENV?=	
LPR?=		@LPR@
LPR_FLAGS?=	
PS2PDF?=	@PS2PDF@
PS2PDF_FLAGS?=	
XDVI?=		@XDVI@
XDVI_FLAGS?=	
VIEWPDF?=	${GV}
VIEWPDF_FLAGS?=	${GV_FLAGS}

RM?=		@RM@

DRAFT_STAMP_PS?=	draft_stamp.ps
DATED_DRAFT_PS?=	${LATEX_MK_DIR}/dated_draft.ps

.MAIN: all
.PHONY: all
default: all

all:: dvi
all:: view-all


# Include other .mk files often times used with LaTeX
BMK:.if defined(TGIFSRCS) || defined(TGIFDIRS)
BMK:.include "tgif.mk"
BMK:.endif

GMK:ifdef TGIFSRCS
_USE_TGIF_MK+=	YES
GMK:endif
GMK:ifdef TGIFDIRS
_USE_TGIF_MK+=	YES
GMK:endif
GMK:ifdef _USE_TGIF_MK
GMK:include ${LATEX_MK_DIR}/tgif.gmk
GMK:endif

BMK:.if defined(XFIGSRCS) || defined(XFIGDIRS)
BMK:.include "xfig.mk"
BMK:.endif

GMK:ifdef XFIGSRCS
_USE_XFIG_MK+=	YES
GMK:endif
GMK:ifdef XFIGDIRS
_USE_XFIG_MK+=	YES
GMK:endif
GMK:ifdef _USE_XFIG_MK
GMK:include ${LATEX_MK_DIR}/xfig.gmk
GMK:endif

BMK:.for __tmp__ in ${NAME}
BMK:.PHONY: view_${__tmp__}
BMK:view_${__tmp__}: ${__tmp__}.dvi
BMK:	$(XDVI) $(XDVI_FLAGS) ${__tmp__}.dvi
BMK:DEFAULTVIEW?=	view_${__tmp__}
BMK:ALLVIEW+=	view_${__tmp__}
BMK:.endfor

BMK:.for __tmp__ in ${NAME}
BMK:.PHONY: viewps_${__tmp__}
BMK:viewps_${__tmp__}: ${__tmp__}.ps
BMK:	$(GV) $(GV_FLAGS)  ${__tmp__}.ps
BMK:DEFAULTVIEWPS?=	viewps_${__tmp__}
BMK:ALLVIEWPS+=	viewps_${__tmp__}
BMK:.PHONY: viewps_${__tmp__}-draft
BMK:viewps_${__tmp__}-draft: ${__tmp__}-draft.ps
BMK:	$(GV) $(GV_FLAGS)  ${__tmp__}-draft.ps
BMK:DEFAULTVIEWPS_DRAFT?=	viewps_${__tmp__}-draft
BMK:ALLVIEWPS_DRAFT+=	viewps_${__tmp__}-draft
BMK:${__tmp__}-draft.ps: ${__tmp__}.dvi
BMK:	sed "s;DATE;`date`;g" ${DATED_DRAFT_PS} > ${DRAFT_STAMP_PS}
BMK:	$(DVIPS) -h ${DRAFT_STAMP_PS} $(DVIPS_FLAGS) -o $@ ${__tmp__}.dvi
BMK:.endfor

BMK:.for __tmp__ in ${NAME}
BMK:.PHONY: viewpdf_${__tmp__}
BMK:viewpdf_${__tmp__}: ${__tmp__}.pdf
BMK:	$(VIEWPDF) $(VIEWPDF_FLAGS)  ${__tmp__}.pdf
BMK:DEFAULTVIEWPDF?=	viewpdf_${__tmp__}
BMK:ALLVIEWPDF+=	viewpdf_${__tmp__}
BMK:.PHONY: viewpdf_${__tmp__}-draft
BMK:viewpdf_${__tmp__}-draft: ${__tmp__}-draft.pdf
BMK:	$(VIEWPDF) $(VIEWPDF_FLAGS)  ${__tmp__}-draft.pdf
BMK:DEFAULTVIEWPDF_DRAFT?=	viewpdf_${__tmp__}-draft
BMK:ALLVIEWPDF_DRAFT+=	viewpdf_${__tmp__}-draft
BMK:.endfor

BMK:.for __tmp__ in ${NAME}
BMK:.PHONY: print_${__tmp__}
BMK:print_${__tmp__}: ${__tmp__}.ps
BMK:	$(LPR) $(LPR_FLAGS) ${__tmp__}.ps
BMK:DEFAULTPRINT?=	print_${__tmp__}
BMK:ALLPRINT+=	print_${__tmp__}
BMK:.PHONY: print_${__tmp__}-draft
BMK:print_${__tmp__}-draft: ${__tmp__}-draft.ps
BMK:	$(LPR) $(LPR_FLAGS) ${__tmp__}-draft.ps
BMK:DEFAULTPRINT_DRAFT?=	print_${__tmp__}-draft
BMK:ALLPRINT_DRAFT+=	print_${__tmp__}-draft
BMK:.endfor

ALLTEXSRCS=	${TEXSRCS}
ALLBIBTEXSRCS=	${BIBTEXSRCS}
# add the dependencies for each documents .dvi file
BMK:.for __tmp__ in ${NAME}
BMK:${__tmp__}.dvi:	${__tmp__}.tex ${TEXSRCS} ${${__tmp__}_TEXSRCS} ${BIBTEXSRCS} ${${__tmp__}_BIBTEXSRCS} ${OTHER} ${${__tmp__}_OTHER}
BMK:
BMK:ALLTEXSRCS+=	${__tmp__}.tex ${${__tmp__}_TEXSRCS}
BMK:ALLBIBTEXSRCS+=	${${__tmp__}_BIBTEXSRCS}
BMK:dvi:	${__tmp__}.dvi
BMK:ps:	${__tmp__}.ps
BMK:pdf:	${__tmp__}.pdf
BMK:ps-draft:	${__tmp__}-draft.ps
BMK:pdf-draft:	${__tmp__}-draft.pdf
BMK:.endfor

GMK:# here is where we wish that .for loops were commonly
GMK:# supported in GNU make...
GMK:# XXX -- we need to not assume its called 'Makefile'.  What if
GMK:#        someone uses gmake -f foo.mk !!!  Stupid GNU make.
GMK:LATEX_MK_TEXDEPS=	latex-mk-texdeps.mk
GMK:LATEX_MK_TEXDEPS_STAMP=	${LATEX_MK_TEXDEPS}_stamp
GMK:${LATEX_MK_TEXDEPS_STAMP}:
GMK:	@touch $@ ; $(RM) ${LATEX_MK_TEXDEPS}
GMK:
GMK:${LATEX_MK_TEXDEPS}: ${LATEX_MK_TEXDEPS_STAMP}
GMK:	@-${RM} $@
GMK:	@-${RM} ${LATEX_MK_TEXDEPS_STAMP}
GMK:	@echo "#############################################" >> $@
GMK:	@echo "### Generated file.  Do not edit directly ###" >> $@
GMK:	@echo "#############################################" >> $@
GMK:	@for tmp in ${NAME} ; do \
GMK:		echo "# Targets for \"$${tmp}\"" >> $@ ; \
GMK:		echo " " >> $@ ; \
GMK:		echo ".PHONY: view_$${tmp}" >> $@ ; \
GMK:		echo "view_$${tmp}: $${tmp}.dvi" >> $@ ; \
GMK:		echo '	$$(XDVI) $$(XDVI_FLAGS) $$<' >> $@ ; \
GMK:		echo "DEFAULTVIEW?= view_$${tmp}" >> $@ ; \
GMK:		echo "ALLVIEW+= view_$${tmp}" >> $@ ; \
GMK:		echo " " >> $@ ; \
GMK:		echo ".PHONY: viewps_$${tmp}" >> $@ ; \
GMK:		echo "viewps_$${tmp}: $${tmp}.ps" >> $@ ; \
GMK:		echo '	$$(GV) $$(GV_FLAGS) $$<' >> $@ ; \
GMK:		echo "DEFAULTVIEWPS?= viewps_$${tmp}" >> $@ ; \
GMK:		echo "ALLVIEWPS+= viewps_$${tmp}" >> $@ ; \
GMK:		echo ".PHONY: viewpdf_$${tmp}" >> $@ ; \
GMK:		echo "viewpdf_$${tmp}: $${tmp}.pdf" >> $@ ; \
GMK:		echo '	$$(VIEWPDF) $$(VIEWPDF_FLAGS) $$<' >> $@ ; \
GMK:		echo "DEFAULTVIEWPDF?= viewpdf_$${tmp}" >> $@ ; \
GMK:		echo "ALLVIEWPDF+= viewpdf_$${tmp}" >> $@ ; \
GMK:		echo "$${tmp}.dvi: $${tmp}.tex \$${TEXSRCS} \$${$${tmp}_TEXSRCS} \\" >> $@ ; \
GMK:		echo "	\$${BIBTEXSRCS} \$${$${tmp}_BIBTEXSRCS} \$${OTHER} \$${$${tmp}_OTHER}" >> $@ ; \
GMK:		echo " " >> $@ ; \
GMK:		echo ".PHONY: print_$${tmp}" >> $@ ; \
GMK:		echo "print_$${tmp}: $${tmp}.ps" >> $@ ; \
GMK:		echo '	$$(LPR) $$(LPR_FLAGS) $$<' >> $@ ; \
GMK:		echo "DEFAULTPRINT?= print_$${tmp}" >> $@ ; \
GMK:		echo "ALLPRINT+= print_$${tmp}" >> $@ ; \
GMK:		echo " " >> $@ ; \
GMK:		echo "# Dependencies for \"$${tmp}\"" >> $@ ; \
GMK:		echo " " >> $@ ; \
GMK:		echo "$${tmp}.dvi: $${tmp}.tex \$${TEXSRCS} \$${$${tmp}_TEXSRCS} \\" >> $@ ; \
GMK:		echo "	\$${BIBTEXSRCS} \$${$${tmp}_BIBTEXSRCS} \$${OTHER} \$${$${tmp}_OTHER}" >> $@ ; \
GMK:		echo " " >> $@ ; \
GMK:		echo "ALLTEXSRCS+=	$${tmp}.tex \$${$${tmp}_TEXSRCS}" >> $@ ; \
GMK:		echo "ALLBIBTEXSRCS+=	\$${$${tmp}_BIBTEXSRCS}" >> $@ ; \
BMK:		echo "$${tmp}-draft.ps: $${tmp}.dvi" >> $@ ; \
BMK:		echo '	sed "s;DATE;`date`;g" $${DATED_DRAFT_PS} > $${DRAFT_STAMP_PS}' >> $@ ; \
BMK:		echo '	$$(DVIPS) -h $${DRAFT_STAMP_PS} $$(DVIPS_FLAGS) -o $$@ $${tmp}.dvi' >> $@ ; \
GMK:		echo "dvi:	$${tmp}.dvi" >> $@ ; \
GMK:		echo "ps:	$${tmp}.ps"  >> $@ ; \
GMK:		echo "pdf:	$${tmp}.pdf" >> $@ ; \
GMK:		echo " " >> $@ ; \
GMK:	done
GMK:include ${LATEX_MK_TEXDEPS}

.PHONY: view
view: ${DEFAULTVIEW}
.PHONY: view-all
view-all: ${ALLVIEW}


.PHONY: viewps
viewps: ${DEFAULTVIEWPS}
.PHONY: viewps-all
viewps-all: ${ALLVIEWPS}

.PHONY: viewpdf
viewpdf: ${DEFAULTVIEWPDF}
.PHONY: viewpdf-all
viewpdf-all: ${ALLVIEWPDF}

.PHONY: viewps-draft
viewps-draft: ${DEFAULTVIEWPS_DRAFT}
.PHONY: viewps-all-draft
viewps-all-draft: ${ALLVIEWPS_DRAFT}

.PHONY: viewpdf-draft
viewpdf-draft: ${DEFAULTVIEWPDF_DRAFT}
.PHONY: viewpdf-all-draft
viewpdf-all-draft: ${ALLVIEWPDF_DRAFT}

.PHONY: print
print: ${DEFAULTPRINT}
.PHONY: print-all
print-all: ${ALLPRINT}

.PHONY: print-draft
print-draft: ${DEFAULTPRINT_DRAFT}
.PHONY: print-all-draft
print-all-draft: ${ALLPRINT_DRAFT}

.SUFFIXES : .tex .dvi .ps .pdf

#######################################
#
# DVI Output (latex)
#
#######################################
.PHONY: dvi
.tex.dvi : 
	$(ENV_PROG) $(LATEX_ENV) $(LATEX-MK) $<

#######################################
#
# Postscript Output (dvips)
#
#######################################
.PHONY:  ps

# if we're doing a *-draft target, then add the 
# DRAFT watermark and time stamp
BMK:.if make(*-draft)
GMK:ifeq ($(findstring -draft,${MAKECMDGOALS}),-draft)
__DRAFT=	yes
BMK:.endif
GMK:endif

.dvi.ps :
BMK:.if defined(__DRAFT)
GMK:ifdef DRAFT
	sed "s;DATE;`date`;g" ${DATED_DRAFT_PS} > ${DRAFT_STAMP_PS}
	$(DVIPS) -h ${DRAFT_STAMP_PS} $(DVIPS_FLAGS) -o $*-draft.ps $<
BMK:.else
GMK:else
	$(DVIPS) $(DVIPS_FLAGS) -o $@ $<
BMK:.endif
GMK:endif

#######################################
#
# PDF Output (ps2pdf)
#
#######################################
.PHONY:  pdf
.ps.pdf :
	$(PS2PDF) $(PS2PDF_FLAGS) $<


#######################################
#
# Clean up (clean)
#
#######################################
CLEAN_FILES+=	${ALLTEXSRCS:.tex=.aux}
CLEAN_FILES+=	${BIBTEXSRCS:.bib=.aux}
CLEAN_FILES+=	${NAME:=.ps}
CLEAN_FILES+=	${NAME:=.pdf}
CLEAN_FILES+=	${NAME:=.aux}
CLEAN_FILES+=	${NAME:=.log}
CLEAN_FILES+=	${NAME:=.dvi}
CLEAN_FILES+=	${NAME:=.log}
CLEAN_FILES+=	${NAME:=.bbl}
CLEAN_FILES+=	${NAME:=.blg}
CLEAN_FILES+=	${NAME:=.lof}
CLEAN_FILES+=	${NAME:=.lot}
CLEAN_FILES+=	${NAME:=.toc}
CLEAN_FILES+=	${NAME:=.out}

CLEAN_FILES+=	${LATEX_MK_TEXDEPS}
CLEAN_FILES+=	${LATEX_MK_TEXDEPS_STAMP}

.PHONY: clean
clean::
	${LATEX-MK} --clean
	$(RM) -f *~ texput.log $(CLEAN_FILES)

.PHONY: distclean
distclean: clean

#######################################
#
# Some helpful debugging targets
#
#######################################
.PHONY: show-var
show-var:
	@${ECHO} ${${VARNAME}}
