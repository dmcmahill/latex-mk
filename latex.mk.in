# $Id: latex.mk.in,v 1.1 2002/05/20 14:25:36 dan Exp $
#
# Makefile fragment for handling LaTeX projects
#
# Copyright (c) 2001, 2002 Dan McMahill
# All rights reserved.
#
# This code is derived from software written by Dan McMahill
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 3. All advertising materials mentioning features or use of this software
#    must display the following acknowledgement:
#        This product includes software developed by Dan McMahill
#  4. The name of the author may not be used to endorse or promote products
#     derived from this software without specific prior written permission.
# 
#  THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
#  IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
#  OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
#  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
#  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
#  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
#  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED
#  AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
#  OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
#  OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
#  SUCH DAMAGE.
#


#######################################
#
# README:
#
# To use this makefile fragment, set the variable:
#	NAME	= Top level project name.  Your top level LaTeX 
#		  file should be called $(NAME).tex
#
#	TEXSRCS	= Additional LaTeX input files (.tex)
#
# and add the line:
#	.include "latex.mk"
# in your top level Makefile
#
# The following variables may be overridden in your top level Makefile
#
#  BIBEX	= the BibTeX executable
#  BIBEX_ENV	= environment variables set when running the BibTeX executable
#  BIBEX_FLAGS	= flags passed to the BibTeX executable
#  DVIPS	= the dvips executable
#  DVIPS_FLAGS	= flags passed to the dvips executable
#  GV		= a postscript previewer executable
#  GV_FLAGS	= flags passed to the postscript previewer executable
#  LATEX	= the LaTeX executable
#  LATEX_ENV	= environment variables set when running the LaTeX executable
#  LATEX_FLAGS	= flags passed to the LaTeX executable
#  LPR		= executable to print postscript files
#  LPR_FLAGS	= flags passed to the executable to print postscript files
#  PS2PDF	= ps2pdf executable
#  PS2PDF_FLAGS	= flags passed to the ps2pdf executable
#  XDVI		= a .dvi previewer executable
#  XDVI_FLAGS	= flags passed to the .dvi previewer executable
#
#######################################


MAKECONF?=			/etc/mk.conf
USER_MAKECONF?=	${HOME}/etc/mk.conf

.if exists(${MAKECONF})
.include "${MAKECONF}"
.endif

.if exists(${USER_MAKECONF})
.include "${USER_MAKECONF}"
.endif


BIBTEX?=	bibtex
DVIPS?=		dvips
DVIPS_FLAGS+=	-Ppdf -j0
ECHO?=		echo
ENV?=		env
GV?=		gv
LATEX?=		latex
LATEX_ENV?=	
LPR?=		lpr
LPR_FLAGS?=	
PS2PDF?=	ps2pdf
PS2PDF_FLAGS?=	
XDVI?=		xdvi
XDVI_FLAGS?=	

RM?=		/bin/rm

# Include other .mk files often times used with LaTeX
.if defined(TGIFSRCS) || defined(TGIFDIRS)
.include "tgif.mk"
.endif

.MAIN: view

# target 'view' will only have latex run once.  Thus the preview
# will not always have all the figure and equation references
# up to date
view: $(NAME).dvi
	$(XDVI) $(XDVI_FLAGS) $(NAME).dvi

viewps: $(NAME).ps
	$(GV) $(GV_FLAGS) $(NAME).ps

print: $(NAME).ps
	$(LPR) $(LPR_FLAGS) $(NAME).ps


#######################################
#
# DVI Output (latex)
#
#######################################
dvi:	$(NAME).dvi

TEXSRCS+=	$(NAME).tex

$(NAME).dvi: $(TEXSRCS) $(BIBTEXSRCS) $(OTHER)
	$(ENV) $(LATEX_ENV) $(LATEX) $(NAME)
.ifdef BIBTEXSRCS
	@$(ECHO) BibTeXing and rerunning LaTeX to get references right
	$(ENV) $(BIBTEX_ENV) $(BIBTEX) $(NAME)
	$(ENV) $(LATEX_ENV) $(LATEX) $(NAME)
.endif
	$(ENV) $(LATEX_ENV) $(LATEX) $(NAME)


#######################################
#
# Postscript Output (dvips)
#
#######################################
ps: $(NAME).ps

$(NAME).ps: $(NAME).dvi
	@${ECHO} "running latex again to make sure all figure/equation references are up to date"
	$(ENV) $(LATEX_ENV) $(LATEX) $(NAME)
	$(DVIPS) $(DVIPS_FLAGS) -o $(NAME).ps $(NAME).dvi

#######################################
#
# PDF Output (ps2pdf)
#
#######################################
pdf: $(NAME).pdf

$(NAME).pdf: $(NAME).ps
	$(PS2PDF) $(PS2PDF_FLAGS) $(NAME).ps 


#######################################
#
# Clean up (clean)
#
#######################################
.ifdef TEXSRCS
CLEAN_FILES+=	${TEXSRCS:.tex=.aux}
.endif

.ifdef BIBTEXSRCS
CLEAN_FILES+=	${BIBTEXSRCS:.bib=.aux}
.endif

clean::
	$(RM) -f *~ $(NAME).ps $(NAME).pdf $(NAME).aux $(NAME).log \
		$(NAME).dvi $(NAME).log $(NAME).bbl $(NAME).blg texput.log $(CLEAN_FILES)

